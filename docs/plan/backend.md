# План: backend

**Назначение:** API доставки фич и дельт; CI/CD-воркер для построения манифестов и версий; сравнение версии клиента с накатанной, формирование и кеширование дельт.

## Контекст

- **Фича** — небольшой проект со своим манифестом и набором файлов-узлов (обычно фича = экран). Узел (файл в фиче): **id** (UUID от пути к файлу), **name** (имя файла), **hash** (content-hash). Иерархия задаётся манифестом (дерево папок и файлов).
- **Дельта** строится сервером при сравнении переданной клиентом версии и версии, опубликованной через админку; хранится только в кешах сервера.
- Клиент передаёт версию и идентификатор фичи; сервер достаёт манифесты двух версий (переданной и опубликованной), сравнивает их, строит дельту (или достаёт из кеша), помещает в кеш при необходимости и отправляет клиенту **дельту вместе с опубликованным манифестом** (либо ответ «изменений не было»).

## Задачи

1. **CI/CD-воркер**
   - Периодический анализ ветки проекта, указанной в настройках админки.
   - Построение дерева хешей по входящим файлам, формирование манифестов по фичам (по каждому направлению — ios/android/web).
   - Версионирование манифестов (привязка к коммиту/тегу или внутренний счётчик версий по платформе).
   - Сохранение артефактов в хранилище (.git-репозиторий или подпапка backend); манифесты версионируются внутри репозитория.

2. **API фич и дельт**
   - Эндпоинт запроса фичи: платформа, идентификатор фичи, версия (передаваемая клиентом).
   - **Холодный старт:** клиент передаёт версию и id фичи → сервер достаёт манифесты двух версий (переданной и опубликованной), сравнивает, строит дельту, помещает её в кеш и отправляет клиенту **дельту вместе с опубликованным манифестом** → клиент применяет дельту, кеширует манифест и рендерит.
   - **Проверка обновлений:** клиент передаёт версию и id фичи → сервер ищет в кеше дельту между переданной и опубликованной версией, достаёт из кеша дельту, отдаёт **дельту вместе с опубликованным манифестом** → клиент применяет дельту к предыдущему манифесту, кеширует новый манифест и рендерит.
   - Если переданная версия совпадает с опубликованной — ответ «изменений не было».

3. **Хранение и структура**
   - Хранение манифестов и файлов фич: структура, согласованная с воркером (например, репозиторий с ветками/тегами или каталог `files/` с подпапками по платформам и версиям). Версия «опубликованная» (накатанная) для каждой платформы хранится в конфиге или БД, доступном backend.

4. **Обратная совместимость**
   - Сохранить текущие `GET /api/v1/files`, `GET /api/v1/files/{platform}`, `GET /api/v1/files/{platform}/{filename}` для статичных файлов.

## Результат

Клиенты всегда получают по фиче **дельту вместе с опубликованным манифестом** (при отличии версий) или «изменений не было»; дельты кешируются на сервере.
