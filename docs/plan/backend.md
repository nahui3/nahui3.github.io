# План: backend

**Назначение:** API доставки фич и дельт; CI/CD-воркер для построения манифестов и версий; сравнение версии клиента с накатанной, формирование и кеширование дельт.

## Контекст

- **Фича** — небольшой проект со своим манифестом и набором файлов-узлов (обычно фича = экран). Узел: ID (UUID от пути к файлу в проекте), имя файла, хеш файла. Иерархия задаётся манифестом (дерево файлов и папок).
- **Дельта** строится сервером при сравнении версии клиента и версии, накатанной через админку; хранится только в кешах сервера.
- Клиент обращается к конкретной фиче (экрану), передаёт версию платформы; сервер возвращает дельту по этой фиче или ответ «изменений не было».

## Задачи

1. **CI/CD-воркер**
   - Периодический анализ ветки проекта, указанной в настройках админки.
   - Построение дерева хешей по входящим файлам, формирование манифестов по фичам (по каждому направлению — ios/android/web).
   - Версионирование манифестов (привязка к коммиту/тегу или внутренний счётчик версий по платформе).
   - Сохранение артефактов в хранилище (.git-репозиторий или подпапка backend); манифесты версионируются внутри репозитория.

2. **API фич и дельт**
   - Эндпоинт запроса фичи: платформа, идентификатор фичи, версия платформы на клиенте.
   - Сервер достаёт соответствующий манифест (опубликованную версию для наката), сравнивает с манифестом, соответствующим версии клиента, строит дельту (или достаёт из кеша), сохраняет в кеш при необходимости и отдаёт дельту клиенту. Если изменений нет — ответ «нет изменений».
   - Эндпоинт полной выдачи фичи (холодный старт): отдать полный набор файлов фичи и манифест при отсутствии у клиента версии или при первом запросе.

3. **Хранение и структура**
   - Хранение манифестов и файлов фич: структура, согласованная с воркером (например, репозиторий с ветками/тегами или каталог `files/` с подпапками по платформам и версиям). Версия «накатанная» для каждой платформы хранится в конфиге или БД, доступном backend.

4. **Обратная совместимость**
   - Сохранить текущие `GET /api/v1/files`, `GET /api/v1/files/{platform}`, `GET /api/v1/files/{platform}/{filename}` для статичных файлов.

## Результат

Клиенты получают по фиче либо полный набор файлов и манифест (холодный старт), либо дельту при отличии версии клиента от накатанной; дельты кешируются на сервере.
